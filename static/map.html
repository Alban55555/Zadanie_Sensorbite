<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Evacuation Routing Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: sans-serif;
      font-size: 13px;
    }
    .control-panel input {
      width: 110px;
      margin-bottom: 4px;
    }
    .meta {
      margin-top: 6px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="control-panel">
    <div><strong>Evacuation route</strong></div>
    <div>
      <label>Start lat: <input id="start_lat" type="number" step="0.0001" value="50.0600"></label><br/>
      <label>Start lon: <input id="start_lon" type="number" step="0.0001" value="19.9400"></label><br/>
      <label>End lat: <input id="end_lat" type="number" step="0.0001" value="50.0610"></label><br/>
      <label>End lon: <input id="end_lon" type="number" step="0.0001" value="19.9410"></label><br/>
    </div>
    <button id="btnRoute">Compute route</button>
    <div class="meta" id="meta"></div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>

  <script>
    // init map (center near your sample data)
    const map = L.map('map').setView([50.0605, 19.9405], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let routeLayer = null;

    async function fetchRoute() {
      const startLat = document.getElementById('start_lat').value;
      const startLon = document.getElementById('start_lon').value;
      const endLat = document.getElementById('end_lat').value;
      const endLon = document.getElementById('end_lon').value;

      const url = `/api/evac/route?start_lat=${startLat}&start_lon=${startLon}&end_lat=${endLat}&end_lon=${endLon}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!res.ok) {
          alert('Error: ' + JSON.stringify(data));
          return;
        }

        // draw route (route is a FeatureCollection)
        if (routeLayer) {
          map.removeLayer(routeLayer);
        }

        routeLayer = L.geoJSON(data.route, {
          style: { color: 'red', weight: 4 }
        }).addTo(map);

        // zoom to route
        map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });

        // update metadata
        const metaDiv = document.getElementById('meta');
        metaDiv.innerText = `Length: ${data.meta.length_m.toFixed(3)} (units of CRS), ` +
                            `edges: ${data.meta.num_edges}, ` +
                            `flooded edges: ${data.meta.avoided_edges}`;
      } catch (err) {
        console.error(err);
        alert('Request failed: ' + err);
      }
    }

    document.getElementById('btnRoute').addEventListener('click', fetchRoute);
  </script>
</body>
</html>
